## **Flyway 使用规范**

> 让数据库结构像代码一样被版本控制，唯一的前提是——**大家共同遵守同一套“游戏规则”。**



------



### **1. 目录与命名**



| **约定**       | **说明**                                                   | **例子**               |
| -------------- | ---------------------------------------------------------- | ---------------------- |
| **统一目录**   | 所有迁移脚本放在dal模块下 /src/main/resources/db/migration | –                      |
| **文件名格式** | V<版本号>__<简短描述>.sql （两个下划线分隔）               | V3__add_user_index.sql |
| **版本号递增** | 整数递增即可，禁止跳号、禁止改号                           | V1 → V2 → V3 …         |

> **禁止** 改动已提交的脚本文件名或内容。脚本一旦跑过，就永久封存。



------



### **2. 基本写法**

- **一个脚本只做一件事**：建表、加索引、填充数据……保持粒度清晰。
- 使用 **IF NOT EXISTS** / **IF EXISTS** 防止重复执行时报错。
- DDL 与 DML 可以混写，但请在脚本内按“DDL → 必需 DML → 可选 DML”顺序组织。



------



### **3. 紧急线上改表怎么办？**

> 线上字段太短，必须马上扩容？该怎么做才不“打补丁留后患”？



1. **先手动改库**，保障业务不中断。
2. 立即在仓库新建一个补丁脚本，例如

```
V42__extend_column_x_length.sql
```



1. 脚本内容只包含你刚才在生产执行的那条 ALTER TABLE。
2. **记日志 / 发群通知**：让所有同事知道已有补丁版本，避免再次手动执行。
3. 其他环境（测试、预发、本地）用正常流程 mvn spring-boot:run / CI 部署即可自动跟进。

> 关键点：**脚本要“追回来”**，让版本链条保持完整；手工操作只能临时救急，最终都得落回版本文件。



------



### **4. 多环境启动选项**



| **场景**         | **建议配置**                                                 |
| ---------------- | ------------------------------------------------------------ |
| 第一次接入老库   | baseline-on-migrate=true 让 Flyway 自动写一条 baseline 记录，后续用增量脚本追赶 |
| 非生产快速重置   | flyway.clean-disabled=false + mvn flyway:clean flyway:migrate（**禁止在生产执行**） |
| 线上仅校验不执行 | flyway.validate-on-migrate=true，CI 阶段跑 flyway:validate   |



------



### **5. 常见命令速查**



| **命令**       | **用途**                     |
| -------------- | ---------------------------- |
| flyway:migrate | 常规迁移                     |
| flyway:clean   | **慎用**，清空所有表         |
| flyway:info    | 查看已执行 / 待执行脚本      |
| flyway:repair  | 修复 checksum 冲突、失败标记 |



------



### **6. 常见雷区提醒**



1. **不要改老脚本**——改动会导致 checksum 不一致，启动报错。
2. **不要跳版本号**——简单地递增整数，避免歧义。
3. **不要把业务数据批量导入脚本**——海量 INSERT 请走专用工具。
4. **不要把脚本放错目录**——Flyway 只扫描 locations 指定的路径。
5. **不要在不同分支各自起版本**——合并时会冲突，请先同步主干。

------



### **7. 结语**

> **“写脚本就像写代码”**——可回溯、可 review、有规范，才配得上“可运维”。

> 希望大家遵守此约定，让数据库演进像应用代码一样优雅、可靠。